<div class="page" id="business-page">
  <!-- Profil Kartı -->
  <div class="card card-style shadow-sm">
    <button class="sidebar-toggle" @click="toggleSidebar">
      <i class="fa fa-ellipsis-v"></i>
    </button>

    <div class="business-header">
      <!-- Profil Fotoğrafı -->
      <ProfileAvatar :name="businessDetails?.name" :photo-url="businessDetails?.p_photo_link" :clickable="false"
        size="221" v-if="businessDetails" />

      <div class="business-info">
        <h1 id="business-username">{{ businessDetails?.name }}</h1>
        <p id="business-bio">{{ businessDetails?.description }}</p>
        <p id="business-bio">{{ businessDetails?.adres }}</p>
        <p>
          <strong id="business-total-views">{{ businessDetails?.nofviews }}</strong>
          {{ $t('pages.business.views') }}
        </p>

        <!-- Taglar -->
        <div class="tags" id="business-tags">
          <i :class="tag?.tag_icon" class="me-1"></i>{{ tag?.[`name_${lang}`] }}
        </div>

        <div class="tags-container mt-2 mb-3">
          <button class="el-check-tag is-checked el-check-tag--primary" type="button">
            <i :class="tag?.icon" class="me-2"></i>
            {{ tag?.[`name_${lang}`] }}
          </button>
        </div>

        <div class="row mb-0 justify-content-center contact-actions">
          <!-- KONUM -->
          <div  class="col col-4" v-if="businessDetails?.adres">
            <a @click="_goToAddress(businessDetails?.adres)" class="contact-pill contact-pill--location">
              <span class="pill-icon"><i class="fas fa-map-marker-alt"></i></span>
              <span class="pill-label">{{ $t('pages.business.contact.location') }}</span>
            </a>
          </div>

          <!-- ARAMA -->
          <div  class="col col-4" v-if="businessDetails?.phone">
            <a :href="'tel:' + businessDetails?.phone" class="contact-pill contact-pill--phone">
              <span class="pill-icon"><i class="fas fa-phone"></i></span>
              <span class="pill-label">{{ $t('pages.business.contact.call') }}</span>
            </a>
          </div>

          <!-- WEBSITE -->
          <div  class="col col-4" v-if="businessDetails?.website">
            <a @click="_openWebsite(businessDetails?.website)" class="contact-pill contact-pill--website">
              <span class="pill-icon"><i class="fas fa-globe"></i></span>
              <span class="pill-label">{{ $t('pages.business.contact.website') }}</span>
            </a>
          </div>

          <!-- WHATSAPP -->
          <div  class="col col-4" v-if="businessDetails?.whatsapp">
            <a @click="_openWebsite('https://wa.me/' + businessDetails?.whatsapp)"
              class="contact-pill contact-pill--whatsapp">
              <span class="pill-icon"><i class="fab fa-whatsapp"></i></span>
              <span class="pill-label">{{ $t('pages.business.contact.whatsapp') }}</span>
            </a>
          </div>

          <!-- INSTAGRAM -->
          <div  class="col col-4" v-if="businessDetails?.instagram">
            <a @click="_openWebsite(businessDetails?.instagram)" class="contact-pill contact-pill--instagram">
              <span class="pill-icon"><i class="fab fa-instagram"></i></span>
              <span class="pill-label">{{ $t('pages.business.contact.instagram') }}</span>
            </a>
          </div>

          <!-- FACEBOOK -->
          <div  class="col col-4" v-if="businessDetails?.facebook">
            <a @click="_openWebsite(businessDetails?.facebook)" class="contact-pill contact-pill--facebook">
              <span class="pill-icon"><i class="fab fa-facebook-f"></i></span>
              <span class="pill-label">{{ $t('pages.business.contact.facebook') }}</span>
            </a>
          </div>

          <!-- MAIL -->
          <div  class="col col-4" v-if="businessDetails?.p_showmail">
            <a :href="'mailto:' + businessDetails?.email" class="contact-pill contact-pill--email">
              <span class="pill-icon"><i class="far fa-envelope"></i></span>
              <span class="pill-label">{{ $t('pages.business.contact.mail') }}</span>
            </a>
          </div>

          <!-- PINTEREST -->
          <div  class="col col-4" v-if="businessDetails?.pinterest">
            <a @click="_openWebsite(businessDetails?.pinterest)" class="contact-pill contact-pill--pinterest">
              <span class="pill-icon"><i class="fab fa-pinterest-p"></i></span>
              <span class="pill-label">{{ $t('pages.business.contact.pinterest') }}</span>
            </a>
          </div>

          <!-- TWITTER / X -->
          <div  class="col col-4" v-if="businessDetails?.twitter">
            <a @click="_openWebsite(businessDetails?.twitter)" class="contact-pill contact-pill--twitter">
              <span class="pill-icon"><i class="fab fa-twitter"></i></span>
              <span class="pill-label">{{ $t('pages.business.contact.twitter') }}</span>
            </a>
          </div>
        </div>

        <!-- ✅ Actions -->
        <div class="profile-actions">
          <!-- Profile varsa normal -->
          <template v-if="hasLinkedProfile">
            <a class="profile-actions__btn profile-actions__btn--primary"
              :class="{ 'profile-actions__btn--primary--active': isFollowed }" @click="toggleFollow">
              {{ isFollowed ? $t('pages.business.actions.followed') : $t('pages.business.actions.follow') }}
            </a>

            <a class="profile-actions__btn profile-actions__btn--outline" @click="goToChat">
              {{ $t('pages.business.actions.sendMessage') }}
            </a>
          </template>

          <!-- Yoksa kilitli + yönlendirme -->
          <template v-else>
            <a class="profile-actions__btn profile-actions__btn--primary is-disabled" @click="openClaim">
              <i class="fas fa-lock me-1"></i> {{ $t('pages.business.actions.claim') }}
            </a>

            <a class="profile-actions__btn profile-actions__btn--outline is-disabled" @click="openEditReq">
              <i class="fas fa-lock me-1"></i> {{ $t('pages.business.actions.fixRequest') }}
            </a>
          </template>
        </div>

        <!-- Profile bağlı değilse bilgi alanı -->
        <div v-if="!hasLinkedProfile" class="biz-link-note mt-3">
          {{ $t('pages.business.unclaimed') }}
          <div class="biz-link-note__actions">
            <button type="button" class="biz-link-note__btn" @click="requestClaim">{{ $t('pages.business.actions.claim')
              }}</button>
            <button type="button" class="biz-link-note__btn biz-link-note__btn--outline" @click="requestFix">{{
              $t('pages.business.actions.fixRequest') }}</button>
          </div>
        </div>

      </div>
    </div>
  </div>



  <section class="profile-tabs card card-style shadow-sm">
    <el-tabs class="profile-tabs__tabs"
    stretch :lazy="true" :model-value="'posts'">
      <el-tab-pane name="posts" class="active">
      <template #label>
        <span class="tab-label">
        {{ $t('pages.profile.tabs.posts') }}
        <span class="tab-count">({{ allPostsCount }})</span>
        </span>
      </template>

      <div class="posts-list">
        <PostCard v-for="post in allPosts" :key="post.id" :post="post" />
      </div>

      <div v-if="!allPostsCount" class="profile-empty">
        {{ $t('pages.profile.empty.noPosts') }}
      </div>
      </el-tab-pane>
    </el-tabs>
  </section>

  <!-- Bu alanı artık "profil bulunamadı" diye kullanma; işletme yine var -->
  <div id="business-not-found" v-if="businessDetails && !hasLinkedProfile">
    <p>Profil bağlantısı bulunamadı.</p>
  </div>

  <!-- Profil Foto Modal -->
  <div id="business-modal" :class="{ active: isModalActive }" @click="closeModal">
    <div class="modal-content">
      <img id="modal-photo" :src="businessDetails?.p_photo" alt="Profil Foto" @click.stop />
    </div>
  </div>

  <!-- Post Lightbox Modal -->
  <div id="post-modal" :class="{ active: isPostModalActive }" @click="closePostModal">
    <div class="modal-content">
      <img :src="currentPostImage" alt="Post Foto" @click.stop />
    </div>
  </div>

  <!-- SAĞ SIDEBAR OVERLAY -->
  <div class="business-sidebar-overlay" v-if="isSidebarOpen" @click="closeSidebar"></div>

  <!-- SAĞ SIDEBAR PANEL -->
  <div class="business-sidebar" :class="{ open: isSidebarOpen }">
    <div class="business-sidebar-header">
      <span>{{ $t('pages.business.sidebar.title') }}</span>
      <button type="button" class="sidebar-close-btn" @click="closeSidebar">
        &times;
      </button>
    </div>

    <div class="business-sidebar-content">
      <div class="sidebar-item">
        <span>{{ $t('pages.business.sidebar.request') }}</span>
        <button type="button" id="sidebar-message-btn" class="sidebar-link-btn" @click="openClaim">
          {{ $t('pages.business.sidebar.claim') }}
        </button>
      </div>
      <div class="sidebar-item">
        <span>{{ $t('pages.business.sidebar.request') }}</span>
        <button type="button" id="sidebar-message-btn" class="sidebar-link-btn" @click="openEditReq">
          {{ $t('pages.business.sidebar.fix') }}
        </button>
      </div>

      <div class="sidebar-item">
        <span>{{ $t('pages.business.sidebar.request') }}</span>
        <button type="button" class="sidebar-link-btn" @click="openReportReq">
          {{ $t('pages.business.sidebar.report') }}
        </button>
      </div>
    </div>
  </div>

  <!-- 1) Claim modal -->
  <ConfirmDialog v-model="claimOpen" :title="$t('pages.business.dialogs.claim.title')" :confirm-text="$t('common.send')"
    :cancel-text="$t('common.cancel')" :loading="claimLoading" @confirm="submitClaim">
    <el-form :model="claimForm" label-position="top">
      <el-form-item :label="$t('pages.business.dialogs.claim.phoneLabel')">
        <el-input v-model="claimForm.phone" placeholder="+32 ..." />
      </el-form-item>

      <el-form-item :label="$t('pages.business.dialogs.claim.noteLabel')">
        <el-input v-model="claimForm.note" type="textarea" :rows="4"
          :placeholder="$t('pages.business.dialogs.claim.notePlaceholder')" maxlength="400" show-word-limit />
      </el-form-item>
    </el-form>
  </ConfirmDialog>

  <!-- 2) Edit request modal -->
  <ConfirmDialog v-model="editOpen" :title="$t('pages.business.dialogs.fix.title')"
    :confirm-text="$t('pages.business.dialogs.fix.btn')" :cancel-text="$t('common.cancel')" :loading="editLoading"
    @confirm="submitEditRequest">
    <el-form :model="editForm" label-position="top">
      <el-form-item :label="$t('pages.business.dialogs.fix.detailsLabel')">
        <el-input v-model="editForm.details" type="textarea" :rows="5"
          :placeholder="$t('pages.business.dialogs.fix.detailsPlaceholder')" maxlength="600" show-word-limit />
      </el-form-item>

      <el-form-item :label="$t('pages.business.dialogs.fix.emailLabel')">
        <el-input v-model="editForm.email" placeholder="mail@..." />
      </el-form-item>
    </el-form>
  </ConfirmDialog>

  <ConfirmDialog v-model="reportOpen" :title="$t('pages.business.dialogs.report.title')"
    :confirm-text="$t('pages.business.dialogs.report.btn')" :cancel-text="$t('common.cancel')" :loading="reportLoading"
    @confirm="submitReportRequest">
    <el-form :model="reportForm" label-position="top">
      <el-form-item :label="$t('pages.business.dialogs.report.reasonLabel')">
        <el-input v-model="reportForm.reason" type="textarea" :rows="5"
          :placeholder="$t('pages.business.dialogs.report.reasonPlaceholder')" maxlength="600" show-word-limit />
      </el-form-item>

      <el-form-item :label="$t('pages.business.dialogs.report.emailLabel')">
        <el-input v-model="reportForm.email" placeholder="mail@..." />
      </el-form-item>
    </el-form>
  </ConfirmDialog>
</div>